#!/bin/bash

VERSION="3.17"
URL="https://microsoft.github.io/language-server-protocol/specifications/lsp/${VERSION}/metaModel/"
SCHEMA_JSON="metaModel.schema.json"
MODEL_JSON="metaModel.json"

HEADER="// ðŸš¨ This file is generated by $(basename "$0")\n\n"
SCHEMA_RS="schema.rs"
MODEL_RS="model.rs"

TMP="${TMPDIR:-${TEMP:-${TMP:-/tmp/}}}"
if [[ "${TMP}" != */ ]]; then
  TMP="${TMP}/"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #

# Change directory to this script
cd $( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

# Downloads
curl --silent --output "${TMP}${SCHEMA_JSON}" "${URL}${SCHEMA_JSON}"
curl --silent --output "${TMP}${MODEL_JSON}" "${URL}${MODEL_JSON}"

# Generate schema
cargo install cargo-typify --quiet
printf "${HEADER}" > "${SCHEMA_RS}"
echo "$(cargo typify --no-builder --output - "${TMP}${SCHEMA_JSON}")" >> "${SCHEMA_RS}"
sed -i '' 's/#\[doc = "\(.*\)"\]/\/\/\/ \1/' "${SCHEMA_RS}"
sed -i '' 's/#\[doc = r"\(.*\)"\]/\/\/\/ \1/' "${SCHEMA_RS}"

# Generate model
printf "${HEADER}" > "${MODEL_RS}"
printf "pub const VERSION: &'static str = \"${VERSION}\";\n" >> "${MODEL_RS}"
printf "pub const MODEL: &'static str = r###\"\n" >> "${MODEL_RS}"
cat "${TMP}${MODEL_JSON}" >> "${MODEL_RS}"
printf "\"###;\n" >> "${MODEL_RS}"

# Format
cargo fmt
